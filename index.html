<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REFLEX ROULETTE | FIXED</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --danger: #ef4444; --gold: #fbbf24; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #game-container { width: 90%; max-width: 600px; text-align: center; padding: 2rem; border-radius: 20px; background: var(--card); box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 2px solid #334155; }
        .screen { display: none; }
        .active { display: block; }
        input { padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; width: 80%; margin: 20px 0; text-align: center; background: #334155; color: white; }
        button { padding: 15px 40px; font-size: 1.2rem; cursor: pointer; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold; margin: 10px; }
        .game-box { width: 100%; height: 250px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 4rem; font-weight: 800; cursor: pointer; user-select: none; margin-top: 20px; }
        .wait { background: #334155; color: #94a3b8; }
        .go { background: var(--success); color: white; box-shadow: 0 0 50px var(--success); }
        .trap { background: var(--danger); color: white; box-shadow: 0 0 50px var(--danger); }
        #debug-log { font-family: monospace; font-size: 10px; color: #64748b; margin-top: 20px; text-align: left; background: #000; padding: 5px; height: 50px; overflow-y: auto; }
        .shake { animation: shake 0.2s infinite; }
        @keyframes shake { 0% {transform: translate(1px, 1px);} 50% {transform: translate(-3px, -2px);} 100% {transform: translate(1px, 1px);} }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="unlock-screen" class="screen active">
            <h1>üéØ Reflex Roulette</h1>
            <p>To start the game and enable sounds:</p>
            <button onclick="unlockAudio()">CLICK TO INITIALIZE</button>
        </div>

        <div id="setup-screen" class="screen">
            <h2>Player <span id="p-count">1</span> of 10</h2>
            <input type="text" id="player-name" placeholder="Enter Name">
            <br>
            <button onclick="startSession()">START ROUNDS</button>
        </div>

        <div id="play-screen" class="screen">
            <h3 id="round-txt">ROUND 1/10</h3>
            <div id="action-box" class="game-box wait" onmousedown="handleClick()">WAIT...</div>
            <p id="feedback" style="font-weight:bold; color:var(--accent); margin-top:10px;"></p>
        </div>

        <div id="result-screen" class="screen">
            <h2 id="winner-tag">üèÜ RESULTS</h2>
            <div id="lb-display"></div>
            <button onclick="nextPlayer()">NEXT PLAYER</button>
            <button style="background:grey" onclick="location.reload()">RESET ENTIRE FESTIVAL</button>
        </div>

        <div id="debug-log">System initialized. Waiting for user...</div>
    </div>

    <script>
        let audioCtx, participants = [], rounds = [], roundNum = 0, state = "idle", startT, timer;
        const log = (msg) => { const d = document.getElementById('debug-log'); d.innerHTML += "<br>> " + msg; d.scrollTop = d.scrollHeight; };

        function unlockAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.resume().then(() => {
                    log("Audio Context Resumed.");
                    show('setup-screen');
                });
            } catch(e) { log("Error: " + e); }
        }

        function playSound(f, d, t="sine") {
            if(!audioCtx) return;
            let o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = t; o.frequency.value = f;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function show(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startSession() {
            let n = document.getElementById('player-name').value;
            if(!n) return alert("Enter Name");
            log("Starting session for: " + n);
            rounds = []; roundNum = 1;
            show('play-screen');
            beginRound();
        }

        function beginRound() {
            state = "waiting";
            const b = document.getElementById('action-box');
            b.className = "game-box wait"; b.innerText = "WAIT...";
            document.getElementById('round-txt').innerText = ROUND ${roundNum}/10;
            
            let delay = 1000 + Math.random() * 3000;
            let trap = Math.random() < 0.2;

            timer = setTimeout(() => {
                if(trap) {
                    state = "trap"; b.className = "game-box trap shake"; b.innerText = "DON'T CLICK";
                    playSound(150, 0.5, "sawtooth");
                    timer = setTimeout(() => { if(state=="trap") finishRound(0, "SAFE!"); }, 1200);
                } else {
                    state = "go"; b.className = "game-box go"; b.innerText = "CLICK!";
                    playSound(800, 0.1); startT = Date.now();
                }
            }, delay);
        }

        function handleClick() {
            if(state=="waiting") { clearTimeout(timer); playSound(100, 0.2, "square"); finishRound(1.5, "EARLY! (+1.5s)"); }
            else if(state=="trap") { clearTimeout(timer); playSound(100, 0.2, "square"); finishRound(1.5, "TRAP! (+1.5s)"); }
            else if(state=="go") { let d = (Date.now()-startT)/1000; playSound(1200, 0.1); finishRound(d, d.toFixed(3)+"s"); }
            state = "idle";
        }

        function finishRound(s, m) {
            rounds.push(s);
            document.getElementById('feedback').innerText = m;
            setTimeout(() => {
                if(roundNum < 10) { roundNum++; beginRound(); }
                else { endSession(); }
            }, 1000);
        }

        function endSession() {
            let avg = rounds.reduce((a,b)=>a+b,0)/10;
            participants.push({n: document.getElementById('player-name').value, s: avg.toFixed(3)});
            let html = "<table style='width:100%'>";
            let sorted = [...participants].sort((a,b)=>a.s - b.s);
            sorted.forEach((p,i) => {
                html += <tr style="${i==0?'color:gold':''}"><td>${i+1}</td><td>${p.n}</td><td>${p.s}s</td></tr>;
            });
            document.getElementById('lb-display').innerHTML = html + "</table>";
            if(participants.length >= 10) document.getElementById('winner-tag').innerText = "üëë WINNER: " + sorted[0].n;
            show('result-screen');
        }

        function nextPlayer() {
            document.getElementById('player-name').value = "";
            document.getElementById('p-count').innerText = participants.length + 1;
            show('setup-screen');
        }
    </script>
</body>
</html>
